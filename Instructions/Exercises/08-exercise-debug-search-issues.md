---
lab:
  title: 検索の問題をデバッグする
---

# 検索の問題をデバッグする

あなたは検索ソリューションを構築しましたが、インデクサーに対する警告がいくつか発生していることに気付きました。

この演習では、Azure AI 検索ソリューションを作成し、サンプル データをインポートしてから、インデクサーに対する警告を解決します。

> **注** この演習を完了するには、Microsoft Azure サブスクリプションが必要です。 アカウントを取得済みでない場合は、[https://azure.com/free](https://azure.com/free?azure-portal=true) から無料評価版にサインアップできます。

## 検索ソリューションを作成する

デバッグ セッションの使用を開始する前に、Azure AI Search サービスを作成する必要があります。

1. [Azure にリソースをデプロイ](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftLearning%2Fmslearn-knowledge-mining%2Fmain%2FLabfiles%2F08-debug-search%2Fazuredeploy.json) - ホストされている VM にいる場合は、このリンクをコピーして VM ブラウザーに貼り付けます。 それ以外の場合は、このリンクを選択すると、必要なすべてのリソースが Azure portal にデプロイされます。

    ![arm デプロイ テンプレートのスクリーンショット。フィールドが入力されています。](../media/08-media/arm-template-deployment.png)

1. **[リソース グループ]** で、指定したリソース グループを選択するか、**[新規作成]** を選択し、「**debug-search-exercise**」と入力します。
1. 最も近い**リージョン**を選択するか、既定値を使用します。
1. **[リソース プレフィックス]** には、「**debugsearch**」と入力し、数字または文字のランダムな組み合わせを追加して、ストレージ名が一意になるようにします。
1. [場所] で、上記で使用したものと同じリージョンを選択します。
1. ウィンドウの下部で **[確認および作成]** を選択します。
1. リソースがデプロイされるまで待ってから、**[リソースグループに移動]** を選択します。

## サンプル データをインポートしてリソースを構成する

リソースを作成したら、ソース データをインポートできるようになりました。

1. 一覧表示されたリソースでストレージ アカウントに移動します。 左側のウィンドウで **[構成]** に移動し、**[BLOB 匿名アクセスを許可する]** を **[有効]** に設定し、**[保存]** を選択します。
1. リソース グループに戻り、検索サービス(search service) を選択します。
1. **[概要]** ウィンドウで、**[データのインポート]** を選択します。

      ![選択されているインポート データ メニューのスクリーンショット。](../media/08-media/import-data.png)

1. [データのインポート] ウィンドウで、[データ ソース] に対して **[サンプル]** を選択します。

      ![入力済みのフィールドを示すスクリーンショット。](../media/08-media/import-data-selection-screen-small.png)

1. サンプルの一覧で、**[hotels-sample]** を選択します。
1. **[次へ: コグニティブ スキルの追加 (省略可能)]** を選択します。
1. **[エンリッチメントの追加]** セクションを展開します。

    ![[機能強化を追加する] オプションのスクリーンショット。](../media/08-media/add-enrichments.png)

1. **[テキストの認知技術]** を選択します。
1. **[次へ: 対象インデックスをカスタマイズします]** を選択します。
1. 既定値のままにして、**[次へ:インデクサーの作成]** を選択します。
1. **[Submit](送信)** をクリックします。

## デバッグ セッションを使用してインデクサーに対する警告を解決する

インデクサーでは次に 50 個のドキュメントの取り込みを開始します。 ただし、インデクサーの状態を確認すると、警告が発生していることがわかります。

![インデクサーに対する 150 件の警告を示すスクリーンショット。](../media/08-media/indexer-warnings.png)

1. 左側のウィンドウで **[デバッグ セッション]** を選択します。
1. **+ デバッグ セッションの追加** を選択します。
1. セッションの名前を指定し、**[インデクサー テンプレート]** で **hotel-sample-indexer** を選択します。
1. **[ストレージ アカウント]** フィールドで、お使いのストレージ アカウントを選択します。 これにより、デバッグ データを保持するためのストレージ コンテナーが自動的に作成されます。
1. マネージド ID を使用した認証のチェック ボックスはオフのままにします。
1. **[保存]** を選択します。
1. 作成が完了したら、Search Service 内のデータに対してデバッグ セッションが自動的に実行されます。 エラーや警告が表示されるはずです。

    依存関係グラフでは、ドキュメントごとに 3 つのスキルに関するエラーがあることを示しています。
    ![機能強化されたドキュメントに対する 3 件のエラーを示すスクリーンショット。](../media/08-media/debug-session-errors.png)

    > **注**: ストレージ アカウントへの接続とマネージド ID の構成に関するエラーが表示される場合があります。 これが発生するのは、匿名 BLOB アクセスを有効にした後すぐにデバッグを行おうとした場合ですが、それでもデバッグ セッションの実行は機能するはずです。 数分後にブラウザー ウィンドウを更新すると、警告は表示されなくなります。

1. 依存関係グラフで、エラーが発生したスキル ノードの 1 つを選択します。
1. スキルの詳細ウィンドウで、**[エラー/警告(1)]** を選択します。

    詳細は次のとおりです。

    *言語コードが無効 '(Unknown)' です。サポートされている言語: af、am、ar、as、az、bg、bn、bs、ca、cs、cy、da、de、el、en、es、et、eu、fa、fi、fr、ga、gl、gu、he、hi、hr、hu、hy、id、it、ja、ka、kk、km、kn、ko、ku、ky、lo、lt、lv、mg、mk、ml、mn、mr、ms、my、ne、nl、no、or、pa、pl、ps、pt-BR、pt-PT、ro、ru、sk、sl、so、sq、sr、ss、sv、sw、ta、te、th、tr、ug、uk、ur、uz、vi、zh-Hans、zh-Hant。詳細については、https://aka.ms/language-service/language-support をご覧ください。*

    依存関係グラフを振り返ると、言語検出スキルには、エラーを含んだ 3 つのスキルへの出力があります。 エラーのあるスキル設定を確認すると、エラーの原因となっているスキル入力が `languageCode` であることがわかります。

1. 依存関係グラフで、**[言語検出]** を選択します。

    ![言語検出スキルの [スキル設定] を示すスクリーンショット。](../media/08-media/language-detection-skill-settings.png)
    スキル設定 JSON を見ると、言語を推測するために使用されているフィールドが `HotelId` であることに注意してください。

    スキルでは ID に基づいて言語を操作できないため、このフィールドがエラー発生の原因となります。

## インデクサーに対する警告を解決する

1. [inputs] の下で **[source]** を選択し、フィールドを `/document/Description` に変更します。
1. **[保存]** を選択します。
1. **[実行]** を選択します。 インデクサーに対するエラーも警告も表示されなくなるはずです。 これでスキルセットを更新できるようになりました。

    ![エラーのない完全な実行を示すスクリーンショット。](../media/08-media/debug-session-complete.png)
   
1. **[変更のコミット]** を選択して、このセッションで行った変更をインデクサーにプッシュします。
1. **[OK]** を選択します。 これで、セッションを削除できます。

次に、スキルセットが Azure AI サービス リソースにアタッチされていることを確認する必要があります。そうしないと、基本クォータに達し、インデクサーがタイムアウトします。 

1. これを行うには、左側のウィンドウで **[スキルセット]** を選択し、**hotels-sample-skillset** を選択します。

    ![スキルセットの一覧を示すスクリーンショット。](../media/08-media/update-skillset.png)
1. **[AI サービスの接続]** を選択した後、一覧から AI サービス リソースを選択します。

    ![スキルセットにアタッチする Azure AI サービス リソースを示すスクリーンショット。](../media/08-media/skillset-attach-service.png)
1. **[保存]** を選択します。

1. 次に、インデクサーを実行して、固定 AI エンリッチメントでドキュメントを更新します。 これを行うには、左側のウィンドウで **[インデクサー]** を選択し、**hotels-sample-indexer** を選択してから、**[実行]** を選択します。  実行が完了したら、警告が 0 になったことがわかります。

    ![解決済みのすべてを示すスクリーンショット。](../media/08-media/warnings-fixed-indexer.png)

## クリーンアップ

 これで演習は完了です。Azure AI 検索サービスの探索が終了した場合は、演習中に作成した Azure リソースを削除してください。 それを行うための最も簡単な方法は、**debug-search-exercise** リソース グループの削除です。
